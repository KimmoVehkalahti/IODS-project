---
title: "IODS"
subtitle: "Assignment 2"

author: "Rong Guang"
date: "09/11/2022"

output: 
  html_document:
    fig_caption: yes
    theme: flatly
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float: true
    number_section: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Insert chapter 2 title here

*Describe the work you have done this week and summarize your learning.*

- Describe your work and results clearly. 
- Assume the reader has an introductory course level understanding of writing and reading R code as well as statistical methods.
- Assume the reader has no previous knowledge of your data or the more advanced methods you are using.

```{r}
date()
```


# 1 Preparing

## 1.1 read the data set

```{r}
learn <- read_csv(file = "data/learning2014.csv")
```

## 1.2 Code categorical data

```{r}
learn <- learn %>% 
  mutate(gender = gender %>%
           factor() %>% 
           fct_recode("Female" = "F",
                      "Male" = "M"))
```

## 1.3 explore the data set

```{r}
#explore dimensions
dim(learn)
```

The data set has 166 observations of 7 variables.

```{r}
#explore structure
str(learn)
```
The data set has six numeric (integer type) variables and one categorical (binary) variable. 

## 1.4 describe the variables

   The data set includes variables about the participants' demographic characteristics such as age and sex. It also includes the participants exam points, and 

### 1.4.1 describe the coninuous variable

```{r}
library(tidyverse)
library(finalfit)
library(DT)
ff_glimpse(learn)$Continuous %>% datatable()
```

The age of the participants was between 17 and 55 years old (median: 22; Q1-Q3:21,27 years old). The 

### 1.4.1 describe the categori variable

```{r}
ff_glimpse(learn)$Categorical %>% datatable()
```

## 1.4 visualize the data set

```{r}
library(GGally)
library(ggplot2)
library(tidyverse)
# create an plot matrix with ggpairs()
my_fn <- function(data, mapping, method="loess", ...){
      p <- ggplot(data = data, mapping = mapping) + 
      geom_point(size = 0.3, color = "coral") + 
      geom_smooth(size = 0.3, method=method, ...)
      p
    }
ggpairs(learn, 
        lower= list(combo = wrap("facethist", bins = 20),
                    continuous = my_fn)
        )

```

# 2. Fitting the model

## 2.1 variable selection

According to the visualization in section 1.4, 

## 2.2 fitting 

```{r}
fit1 <- learn %>% 
  lm(points ~ attitude  + poly(age, 2, raw =T) + gender, data = .)
summary(fit1)
```

## 2.3 removig insignifiant predictor

```{r}
fit2 <- learn %>% 
  lm(points ~ attitude  + poly(age, 2, raw =T), data = .)
summary(fit2)
```

# 3. Model diagnostic

## 3.1 diagnostic plots

```{r}
par(mfrow =c(2,2))+
plot(fit2, which = c(1,2,4)) 

cooksd <- cooks.distance(fit2)
cooksd <- data.frame(index = 1:length(cooksd), cooksd = cooksd)

plot(cooksd$index, 
     cooksd$cooksd, 
     pch="*", cex=1.5, 
     main="Influential Obs by Cooks distance") +
abline(h = 4*mean(cooksd$cooksd), 
       col="red")+
text(x=cooksd$index+4, 
     y=cooksd$cooksd, 
     labels= ifelse(cooksd$cooksd>4*mean(cooksd$cooksd, na.rm=T),
                    cooksd$index,""),
     col="red")

```

## 3.2 other model assumptions

## 3.3 influential observations

***********************

```{r}

learn <- learn %>% mutate(index = 1:nrow(learn))
learn <- left_join(learn, cooksd, by = "index")
learn %>% filter(index %in% c(1,4,3,10,19,24,35,56,154))
learn %>% filter(age>40)

```




```{r}
fit.3predictor <- lm(points ~ attitude + stra + stra.factor + gender, data = learn)
summary(fit.3predictor)

fit.2predictor <- lm(points ~ attitude + stra + stra.factor, data = learn)
summary(fit.2predictor)

fit.1predictor <- lm(points ~ attitude + stra, data = learn)
summary(fit.1predictor)

fit.0predictor <- lm(points ~ attitude + stra * stra.factor, data = learn)
summary(fit.0predictor)

fit.predictor <- lm(points ~ attitude + stra.factor, data = learn)
summary(fit.predictor)

fit.predictor <- lm(points ~ attitude + age + stra, data = learn)
summary(fit.predictor)


learn %>% 
  filter(stra.factor == "Low Stra") %>% 
  ggplot(aes (x = stra, y = points))+
  geom_point()+
  geom_smooth(method = "lm")

p1 <- learn %>% 
  filter(stra.factor == "High Stra") %>% 
  ggplot(aes (x = stra, y = points))+
  geom_point()+
  geom_smooth(method = "lm")


learn  %>% 
  ggplot(aes (x = stra, y = points))+
  geom_point()+
  geom_smooth(method = "loess")
```


```{r}
USHSv2 <- USHSv2 %>% mutate(BMI.factor = BMI %>%  #turn BMI into factor and add labels(underweight:<18.5,                                                   #normal weight: ~25, overweight: ~30; obese: >30)
                    cut(breaks=c(1,18.5,25,30,100), include.lowest = T) %>% 
                    fct_recode("Underweight" = "[1,18.5]",
                               "Normal weight" = "(18.5,25]",
                               "Overweight" = "(25,30]",
                               "Obese" = "(30,100]") %>% 
                    ff_label("BMI ranges"))
```


```{r}
earn  %>% ggplot(aes (x = stra, y = points)) +
  geom_point()+
  geom_smooth(method = "loess")

learn %>% ggplot(aes(x = age))+
  geom_boxplot()+
  coord_flip()

fit_age <- lm(points ~ age, data = learn)
summary(fit_age)
cooksd <- cooks.distance(fit_age)
cooksd %>% broom::tidy()
plot(cooksd, pch="*", cex=2, main="Influential Obs by Cooks distance") +
abline(h = 4*mean(cooksd), col="red")+
text(x=1:length(cooksd)+3.5, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")

learn$fit_age_cooksd <- cooksd
learn1 <- learn %>% filter(fit_age_cooksd<4*mean(fit_age_cooksd))

p2 <- learn1  %>% ggplot(aes (x = age, y = points)) +
  geom_point()+
  geom_smooth(method = "loess")
library(patchwork)
p1
learn <- learn %>% mutate(age.factor = age %>% 
                            cut(breaks =c(0,19,22,25,27,34,100)))
learn %>% count(age.factor)
learn %>% 
  filter(age.factor == "(19,22]") %>% 
  ggplot(aes (x = age, y = points))+
  geom_point()+
  geom_smooth(method = "loess")

fit_age1 <- learn %>% 
  filter (age.factor == "(19,22]")%>% 
  lm(points ~ age, data = .)
summary(fit_age1)

p1
```

```{r}
learn <- learn %>% 
  mutate(stra.factor = stra %>%
           cut(breaks =c(0,3,6)) %>%
                 fct_recode("High Stra" = "(0,3]",
                            "Low Stra" = "(3,6]") %>% 
           ff_label ("Stra dichotomized"))
```

```{r}
par(cex = 0.5,fig=c(0,0.5,0.5,1))+
plot(fit2, which = 1) 

par(cex = 0.5,fig=c(0.5,1,0.5,1), new=TRUE)+
plot(fit2, which = 2) 

par(cex = 0.5, fig=c(0,1,0,0.5), new=TRUE)+
plot(fit2, which = 4)
```



Here we go again...

a test to see if it works